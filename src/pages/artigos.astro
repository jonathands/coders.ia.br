---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { User, Calendar, BookOpen } from 'lucide-astro';

// Get all published blog posts with dates in the past, sorted by date (newest first)
const allPosts = await getCollection('blog', ({ data }) => {
  const now = new Date();
  return data.draft !== true && data.date <= now;
});

const posts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get unique categories
const categories = [...new Set(posts.map(post => post.data.category))];

function getExcerpt(post: any) {
  // Use excerpt if available, otherwise fall back to description
  return post.data.excerpt || post.data.description || 'Sem descrição disponível.';
}

function formatDate(date: Date) {
  return date.toLocaleDateString('pt-BR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

function getCategoryColor(category: string) {
  const colors = [
    'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500',
    'bg-lime-500', 'bg-green-500', 'bg-emerald-500', 'bg-teal-500',
    'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 'bg-indigo-500',
    'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 'bg-pink-500',
    'bg-rose-500'
  ];

  const firstChar = category.charAt(0).toLowerCase().charCodeAt(0);
  const lastChar = category.charAt(category.length - 1).toLowerCase().charCodeAt(0);
  const colorIndex = (firstChar + lastChar) % colors.length;

  return colors[colorIndex];
}
---

<BaseLayout
  title="Todos os Artigos - Coders.ia.br"
  description="Explore todos os artigos publicados no Coders.ia.br sobre desenvolvimento web, inteligência artificial, ferramentas e tecnologias modernas."
>
  <div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="text-center mb-12">
      <div class="flex items-center justify-center mb-4">
        <BookOpen class="w-12 h-12 text-accent-500" />
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
        Todos os Artigos
      </h1>
      <p class="text-xl text-slate-300 max-w-2xl mx-auto">
        {posts.length} {posts.length === 1 ? 'artigo publicado' : 'artigos publicados'} sobre desenvolvimento, IA e tecnologia
      </p>
      <div class="w-24 h-1 bg-gradient-to-r from-accent-500 to-primary-500 mx-auto mt-6 rounded-full"></div>
    </div>

    <!-- Category Filters -->
    {categories.length > 0 && (
      <div class="mb-12">
        <div class="flex flex-wrap justify-center gap-3">
          <button
            data-category="all"
            class="category-filter active px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-accent-600 text-white"
          >
            Todos ({posts.length})
          </button>
          {categories.map((category) => {
            const categoryPosts = posts.filter(post => post.data.category === category);
            return (
              <button
                data-category={category}
                class="category-filter px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-slate-800/50 text-slate-300 hover:bg-slate-700/50 hover:text-white border border-slate-700 hover:border-accent-500/50"
              >
                {category} ({categoryPosts.length})
              </button>
            );
          })}
        </div>
      </div>
    )}

    <!-- Posts List -->
    {posts.length > 0 && (
      <div class="space-y-6">
        {posts.map((post) => (
          <article
            class="post-item bg-slate-800/30 rounded-xl overflow-hidden border border-slate-700 hover:border-accent-500/50 transition-all duration-300 hover:shadow-xl hover:shadow-accent-500/10 group"
            data-category={post.data.category}
          >
            <div class="p-6 md:p-8">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                <div class="flex items-center space-x-4">
                  <span class={`inline-block px-3 py-1 text-xs font-medium rounded-lg border ${getCategoryColor(post.data.category)} bg-opacity-20 border-opacity-30`}>
                    {post.data.category}
                  </span>
                  <div class="flex items-center space-x-2 text-sm text-slate-400">
                    <Calendar class="w-4 h-4" />
                    <time>{formatDate(post.data.date)}</time>
                  </div>
                </div>

                <div class="flex items-center space-x-2 text-sm text-slate-400">
                  <User class="w-4 h-4" />
                  <span>{post.data.author}</span>
                </div>
              </div>

              <h2 class="text-2xl md:text-3xl font-bold text-white mb-3 leading-tight group-hover:text-accent-400 transition-colors duration-200">
                <a href={`/blog/${post.slug}`}>
                  {post.data.title}
                </a>
              </h2>

              <p class="text-slate-300 text-base md:text-lg mb-4 leading-relaxed line-clamp-2">
                {getExcerpt(post)}
              </p>

              {post.data.tags && post.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-4">
                  {post.data.tags.slice(0, 5).map((tag: string) => (
                    <span class="px-2 py-1 text-xs bg-slate-700/50 text-slate-300 rounded border border-slate-600">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}

              <a
                href={`/blog/${post.slug}`}
                class="inline-flex items-center space-x-2 text-accent-400 hover:text-accent-300 font-medium transition-colors duration-200"
              >
                <span>Ler artigo completo</span>
                <span>→</span>
              </a>
            </div>
          </article>
        ))}
      </div>
    )}

    <!-- Empty State -->
    {posts.length === 0 && (
      <div class="text-center py-16">
        <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6">
          <BookOpen class="w-12 h-12 text-slate-500" />
        </div>
        <h2 class="text-2xl font-semibold text-white mb-2">Nenhum artigo encontrado</h2>
        <p class="text-slate-400">Parece que ainda não temos posts publicados.</p>
      </div>
    )}
  </div>
</BaseLayout>

<script>
  // Category filtering functionality
  function initCategoryFilters() {
    const filterButtons = document.querySelectorAll('.category-filter');
    const postItems = document.querySelectorAll('.post-item');

    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const category = button.getAttribute('data-category');

        // Update active state
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-accent-600', 'text-white');
          btn.classList.add('bg-slate-800/50', 'text-slate-300', 'border', 'border-slate-700');
        });
        button.classList.add('active', 'bg-accent-600', 'text-white');
        button.classList.remove('bg-slate-800/50', 'text-slate-300', 'border', 'border-slate-700');

        // Filter posts
        postItems.forEach(post => {
          if (category === 'all' || post.getAttribute('data-category') === category) {
            post.style.display = 'block';
            setTimeout(() => {
              post.style.opacity = '1';
              post.style.transform = 'translateY(0)';
            }, 10);
          } else {
            post.style.opacity = '0';
            post.style.transform = 'translateY(-10px)';
            setTimeout(() => {
              post.style.display = 'none';
            }, 300);
          }
        });
      });
    });
  }

  // Initialize on page load
  initCategoryFilters();

  // Re-initialize on Astro page transitions (if using View Transitions)
  document.addEventListener('astro:page-load', initCategoryFilters);
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .post-item {
    opacity: 1;
    transform: translateY(0);
    transition: all 0.3s ease;
  }

  .category-filter.active {
    box-shadow: 0 4px 6px -1px rgb(var(--accent-500) / 0.3);
  }
</style>
